<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cotizaciones Legales</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öñÔ∏è Sistema de Cotizaciones Legales</h1>
            <p>Soluciones jur√≠dicas profesionales con tecnolog√≠a avanzada</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('nueva-cotizacion')">Nueva Cotizaci√≥n</button>
            <button class="nav-tab" onclick="switchTab('historial')">Historial de Cotizaciones</button>
        </div>
        
        <div class="tab-content">
            <div id="nueva-cotizacion" class="tab-panel active">
                <form id="cotizacionForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nombre_cliente">üë§ Nombre del Cliente</label>
                            <input type="text" id="nombre_cliente" name="nombre_cliente" class="form-control" placeholder="Ingrese el nombre completo" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="email">üìß Correo Electr√≥nico</label>
                            <input type="email" id="email" name="email" class="form-control" placeholder="ejemplo@correo.com" required>
                        </div>
                        
                        <div class="form-group large">
                            <label for="tipo_servicio">‚öñÔ∏è Tipo de Servicio Legal</label>
                            <select id="tipo_servicio" name="tipo_servicio" class="form-control" required>
                                <option value="">Seleccione un servicio legal</option>
                                <option value="Constituci√≥n de empresa">Constituci√≥n de empresa (S/ 1,500)</option>
                                <option value="Defensa laboral">Defensa laboral (S/ 2,000)</option>
                                <option value="Consultor√≠a tributaria">Consultor√≠a tributaria (S/ 800)</option>
                            </select>
                        </div>
                        
                        <div class="form-group large">
                            <label for="descripcion">üìù Descripci√≥n Detallada del Caso</label>
                            <textarea id="descripcion" name="descripcion" class="form-control" placeholder="Describa los detalles espec√≠ficos de su caso legal, antecedentes relevantes y objetivos esperados..." required></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn">üöÄ Generar Cotizaci√≥n Profesional</button>
                </form>
                
                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Generando cotizaci√≥n personalizada con an√°lisis IA...</p>
                </div>
                
                <div id="success-message" class="success-message hidden">
                    ‚úÖ Cotizaci√≥n generada exitosamente y guardada en el historial
                </div>
                
                <div id="resultado" class="resultado-card hidden">
                    <div class="resultado-header">
                        <h2>üìã Cotizaci√≥n Profesional</h2>
                        <div id="numero-cotizacion" class="numero-cotizacion"></div>
                    </div>
                    <div id="cotizacionData"></div>
                    
                    <!-- Secci√≥n del An√°lisis IA -->
                    <div id="analisisIA" class="analisis-ia">
                        <h3>ü§ñ An√°lisis Inteligente del Caso</h3>
                        <div id="analisisContent"></div>
                    </div>
                </div>
            </div>
            
            <!-- Historial -->
            <div id="historial" class="tab-panel">
                <div class="filter-section">
                    <h3>üîç Filtrar Cotizaciones</h3>
                    <div class="filter-grid">
                        <div class="form-group">
                            <label for="filtro-servicio">Filtrar por Tipo de Servicio</label>
                            <select id="filtro-servicio" class="form-control">
                                <option value="">Todos los servicios</option>
                                <option value="Constituci√≥n de empresa">Constituci√≥n de empresa</option>
                                <option value="Defensa laboral">Defensa laboral</option>
                                <option value="Consultor√≠a tributaria">Consultor√≠a tributaria</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" onclick="aplicarFiltros()">üîç Filtrar</button>
                    </div>
                </div>
                
                <div id="historial-content">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <h3>No hay cotizaciones a√∫n</h3>
                        <p>Las cotizaciones que generes aparecer√°n aqu√≠</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cotizaciones = [];

        function switchTab(tabId) {
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar la pesta√±a seleccionada
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            
            if (tabId === 'historial') {
                cargarCotizaciones().then(() => {
                    mostrarHistorial();
                });
            }
        }

        window.addEventListener('load', () => {
            cargarCotizaciones();
        });

        // Funci√≥n para limpiar el formulario
        function limpiarFormulario() {
            document.getElementById('cotizacionForm').reset();
        }

        function mostrarExito() {
            const successMsg = document.getElementById('success-message');
            successMsg.classList.remove('hidden');
            setTimeout(() => {
                successMsg.classList.add('hidden');
            }, 3000);
        }

        async function cargarCotizaciones() {
            try {
                const response = await fetch('/api/cotizaciones');
                if (response.ok) {
                    cotizaciones = await response.json();
                }
            } catch (error) {
                console.error('Error al cargar cotizaciones:', error);
            }
        }

        document.getElementById('cotizacionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Mostrar loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultado').classList.add('hidden');
            
            try {
                const formData = new FormData(this);
                const response = await fetch('/generar-cotizacion', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Error en el servidor');
                }
                
                const data = await response.json();
                
                document.getElementById('loading').classList.add('hidden');
                
                mostrarCotizacion(data);
                
                await cargarCotizaciones();
                
                limpiarFormulario();
                mostrarExito();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').classList.add('hidden');
                alert('Error al generar la cotizaci√≥n. Por favor, intente nuevamente.');
            }
        });

        function mostrarCotizacion(data) {
            document.getElementById('numero-cotizacion').textContent = data.numero_cotizacion;
            
            document.getElementById('cotizacionData').innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Cliente</div>
                        <div class="info-value">${data.nombre_cliente}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Email</div>
                        <div class="info-value">${data.email}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Servicio</div>
                        <div class="info-value">${data.tipo_servicio}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Fecha</div>
                        <div class="info-value">${new Date(data.fecha).toLocaleDateString('es-PE')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Precio Base</div>
                        <div class="info-value">S/ ${data.precio_base.toLocaleString()}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Precio Final</div>
                        <div class="info-value precio-destacado">S/ ${Math.round(data.precio_final).toLocaleString()}</div>
                    </div>
                </div>
                
                <div class="info-item large">
                    <div class="info-label">Descripci√≥n del Caso</div>
                    <div class="info-value">${data.descripcion}</div>
                </div>
            `;
            
            if (data.analisis_ia) {
                const analisis = data.analisis_ia;
                let serviciosAdicionales = '';
                
                if (analisis.servicios_adicionales && analisis.servicios_adicionales.length > 0) {
                    serviciosAdicionales = analisis.servicios_adicionales.join(', ');
                } else {
                    serviciosAdicionales = 'Ninguno';
                }
                
                document.getElementById('analisisContent').innerHTML = `
                    <div class="analisis-grid">
                        <div class="analisis-item">
                            <div class="info-label">Complejidad del Caso</div>
                            <div class="info-value">${analisis.complejidad || 'Media'}</div>
                        </div>
                        <div class="analisis-item">
                            <div class="info-label">Ajuste de Precio</div>
                            <div class="info-value">${analisis.ajuste_precio || 0}%</div>
                        </div>
                        <div class="analisis-item">
                            <div class="info-label">Servicios Adicionales</div>
                            <div class="info-value">${serviciosAdicionales}</div>
                        </div>
                    </div>
                    
                    <div class="propuesta-texto">
                        <div class="info-label">Propuesta Personalizada</div>
                        <div class="info-value">${analisis.propuesta_texto || 'Propuesta generada autom√°ticamente'}</div>
                    </div>
                `;
            } else {
                document.getElementById('analisisContent').innerHTML = `
                    <div class="propuesta-texto">
                        <div class="info-value">An√°lisis en proceso... La IA est√° evaluando su caso.</div>
                    </div>
                `;
            }
            
            document.getElementById('resultado').classList.remove('hidden');
        }

        function mostrarHistorial() {
            const historialContent = document.getElementById('historial-content');
            
            if (cotizaciones.length === 0) {
                historialContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <h3>No hay cotizaciones a√∫n</h3>
                        <p>Las cotizaciones que generes aparecer√°n aqu√≠</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="historial-grid">';
            cotizaciones.forEach(cotizacion => {
                const fecha = new Date(cotizacion.fecha).toLocaleDateString('es-PE');
                html += `
                    <div class="cotizacion-card" data-servicio="${cotizacion.tipo_servicio}">
                        <div class="resultado-header">
                            <h3>${cotizacion.numero_cotizacion}</h3>
                            <div class="numero-cotizacion">${fecha}</div>
                        </div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Cliente</div>
                                <div class="info-value">${cotizacion.nombre_cliente}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Email</div>
                                <div class="info-value">${cotizacion.email}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Servicio</div>
                                <div class="info-value">${cotizacion.tipo_servicio}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Precio Final</div>
                                <div class="info-value precio-destacado">S/ ${Math.round(cotizacion.precio).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="info-item" style="margin-top: 15px;">
                            <div class="info-label">Descripci√≥n</div>
                            <div class="info-value">${cotizacion.descripcion}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            historialContent.innerHTML = html;
        }

        function aplicarFiltros() {
            const filtroServicio = document.getElementById('filtro-servicio').value;
            const cotizacionCards = document.querySelectorAll('.cotizacion-card');
            
            cotizacionCards.forEach(card => {
                const servicioCard = card.getAttribute('data-servicio');
                if (filtroServicio === '' || servicioCard === filtroServicio) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
